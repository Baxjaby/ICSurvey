<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Illume Feedback Survey</title>

  <style>
  /* brand header */
  .site-head{
    display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
    margin:24px auto 12px; width:min(720px,92%);
  }
  .brand-logo{ height:48px; width:auto; margin-bottom:6px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.3)); }
  .page-title{ color:var(--gold); font-size:28px; margin:0; }
  .subtitle{ opacity:.8; font-size:.9rem; margin-top:2px; }
  @media (max-width:600px){ .brand-logo{ height:40px; } .page-title{ font-size:24px; } }

  /* theme + layout */
  :root { --bg:#0f1115; --card:#171a21; --ink:#e6e6ea; --muted:#a9abb3; --gold:#c3985a; --bad:#e5534b; --okay:#3fb950; }
  html,body{ margin:0; padding:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
  .wrap{ max-width:960px; margin:24px auto; padding:0 16px; }
  h1{ font-size:28px; margin:0; color:var(--gold); letter-spacing:.3px; }

  .card{ background:var(--card); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.3); }
  .row{ display:grid; grid-template-columns:1fr; gap:14px; }
  label{ display:block; font-weight:600; margin-bottom:6px; }
  select, input[type="text"], input[type="email"], textarea{
    width:100%; background:#0d0f14; border:1px solid #2a2f3a; color:var(--ink);
    border-radius:10px; padding:10px 12px; outline:none;
  }
  textarea{ min-height:96px; resize:vertical; }

  .pill{ display:inline-flex; align-items:center; gap:6px; background:#0d0f14; border:1px solid #2a2f3a;
    border-radius:999px; padding:8px 12px; user-select:none; }
  .pill input[type="checkbox"]{ appearance:auto; accent-color:var(--gold); }
  .choices{ display:flex; gap:8px; flex-wrap:wrap; }
  .subtle{ color:var(--muted); font-size:12px; }
  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
  button{ background:var(--gold); color:#111; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
  button.secondary{ background:#0d0f14; color:var(--ink); border:1px solid #2a2f3a; }
  button.warn{ background:#e5534b; color:#fff; }
  .hide{ display:none !important; }
  .req{ color:var(--bad); margin-left:6px; font-weight:700; }
  .inline-input{ display:inline-block; width:220px; vertical-align:middle; margin-left:8px; }

  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px; }
  .modal{ background:#12151c; border:1px solid #2a2f3a; border-radius:16px; max-width:520px; width:100%; padding:18px; box-shadow:0 10px 32px rgba(0,0,0,.4); }
  .modal h2{ margin:0 0 8px 0; color:var(--okay); }
  .modal .muted{ color:var(--muted); font-size:12px; }
  .admin-note{ font-size:12px; color:var(--muted); }
  </style>

  <!-- Cache buster -->
  <script>
    const APP_VERSION = "2025-09-18-v4";
    try {
      const KEY = "ILLUME_APP_VERSION";
      if (localStorage.getItem(KEY) !== APP_VERSION) {
        localStorage.setItem(KEY, APP_VERSION);
        const u = new URL(location.href);
        u.searchParams.set("v", APP_VERSION);
        if (location.search !== u.search) location.replace(u.toString());
      }
    } catch (_) {}
  </script>
</head>

<body>
  <!-- the only header on the page -->
  <header class="site-head">
    <img src="illume-logo.png" alt="Illume" class="brand-logo">
    <h1 class="page-title">Illume Feedback Survey</h1>
    <p class="subtitle">Choose your customer type to see relevant questions.</p>
  </header>
  <div id="lockNotice" class="subtle hide" style="text-align:center; margin:4px 0 10px;"></div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="row">
          <div>
            <label>First name</label>
            <input id="firstName" type="text" placeholder="First name (optional)">
          </div>
          <div>
            <label>Last name</label>
            <input id="lastName" type="text" placeholder="Last name (optional)">
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com (optional)">
          </div>
        </div>

        <div>
          <label for="role">Which best describes you? <span class="req">*</span></label>
          <select id="role" required>
            <option value="">Select...</option>
            <option>Magazine Advertiser</option>
            <option>Magazine Subscriber</option>
            <option>Event Attendee</option>
            <option>Event Instructor</option>
            <option>Event Vendor</option>
            <option>Learn Instructor</option>
            <option>Learn Subscriber</option>
          </select>
        </div>

        <div id="formFields" class="row"></div>

        <div class="actions">
          <button id="submitBtn">Submit Response</button>

          <span id="adminControls" class="hide" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="secondary" id="exportCsvBtn">Export CSV</button>
            <button class="secondary" id="exportJsonBtn">Export JSON</button>
            <button class="secondary" id="importJsonBtn">Import JSON</button>
            <button class="warn" id="clearBtn">Clear Stored Responses</button>
            <button class="secondary" id="resetLockBtn">Reset 14-day lock</button>
            <button class="secondary" id="adminSignOut">Exit Admin</button>
          </span>
        </div>
        <div class="subtle">Responses save in this browser. Export before clearing cache or switching devices.</div>
        <div id="adminHint" class="admin-note hide">Admin mode enabled.</div>
      </div>
    </div>
  </div>

  <div id="backdrop" class="modal-backdrop">
    <div class="modal">
      <h2>Thanks, your response has been submitted</h2>
      <div id="confirmBody"></div>
      <p class="muted">Thank you! Your response has been recorded you may close this window.</p>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="closeModal">Close</button>
        <button class="secondary" id="downloadCsvQuick">Download CSV</button>
      </div>
    </div>
  </div>

  <script>
/* ============== Admin Mode ============== */
const ADMIN_PASSPHRASE = "sunset-saddle";
const ADMIN_FLAG_KEY = "illume_admin_mode";

function setAdminMode(on){
  localStorage.setItem(ADMIN_FLAG_KEY, on ? "1" : "0");
  document.getElementById("adminControls").classList.toggle("hide", !on);
  document.getElementById("adminHint").classList.toggle("hide", !on);
}
document.addEventListener("keydown", (e)=>{
  if(e.key.toLowerCase() === "a" && e.shiftKey){
    const input = prompt("Enter admin passphrase:");
    if(input && input.trim() === ADMIN_PASSPHRASE){
      setAdminMode(true);
      alert("Admin mode enabled");
    } else if(input != null) {
      alert("Incorrect passphrase");
    }
  }
});
(function(){
  const m = location.hash.match(/#admin=(.+)$/);
  if(m && decodeURIComponent(m[1]) === ADMIN_PASSPHRASE) setAdminMode(true);
  else setAdminMode(localStorage.getItem(ADMIN_FLAG_KEY) === "1");
})();
document.addEventListener("DOMContentLoaded", ()=>{
  const btn = document.getElementById("adminSignOut");
  if(btn){
    btn.addEventListener("click", ()=>{
      localStorage.removeItem(ADMIN_FLAG_KEY);
      document.getElementById("adminControls").classList.add("hide");
      document.getElementById("adminHint").classList.add("hide");
      alert("Admin mode disabled");
    });
  }
});
    document.addEventListener("DOMContentLoaded", () => {
  const resetBtn = document.getElementById("resetLockBtn");
  if (resetBtn) {
    resetBtn.addEventListener("click", () => {
      if (!confirm("Reset the 14-day submission lock on this browser?")) return;
      clearLock();        // removes the localStorage lock
      updateLockUI();     // re-enables the form and hides the notice
      alert("Lock cleared");
    });
  }
});

/* ============== Schema ============== */
const schema = {
  "Magazine Subscriber": [
    { key:"mag_sat", label:"On a scale of 1-5, how satisfied are you with Illume Magazine?", type:"scale5" },
    { key:"mag_enjoy", label:"What do you enjoy most about the magazine?", type:"checkbox",
      options:["Historical pieces","Business tips","Artisan spotlights","Industry news","Skill demonstrations","Supplier connections"], other:true },
    { key:"mag_format", label:"Do you prefer reading the magazine in the print or digital format?", type:"single",
      options:["Print","Digital","Both"] },
    { key:"mag_reco", label:"How likely are you to recommend Illume to a fellow leatherworker?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] }
  ],
  "Magazine Advertiser": [
    { key:"adv_sat", label:"How satisfied are you with your advertising experience with Illume?", type:"scale5" },
    { key:"adv_lift", label:"Have you noticed an increase in customer inquiries or sales from your ad?", type:"yesno" },
    { key:"adv_again", label:"How likely are you to advertise with us again?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] },
    { key:"adv_improve", label:"What could we improve to make advertising with Illume more valuable to you?", type:"text" }
  ],
  "Learn Subscriber": [
    { key:"learn_sat", label:"How satisfied are you with your Learn with Illume experience?", type:"scale5" },
    { key:"learn_chooser", label:"What determines your course selection most of the time?", type:"single",
      options:["Skill level","Project type","Instructor"], other:true },
    { key:"learn_freq", label:"How often are you in the platform?", type:"single",
      options:["Daily","Weekly","Monthly","Rarely"] },
    { key:"learn_renew", label:"How likely are you to continue your subscription next month?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] },
    { key:"learn_better", label:"What is one thing that could improve your learning experience on Illume?", type:"text" }
  ],
  "Learn Instructor": [
    { key:"teach_sat", label:"How satisfied are you with your experience as an instructor on Learn with Illume?", type:"scale5" },
    { key:"teach_process", label:"How is the process of outlining and filming courses with the Illume team?", type:"scale5" },
    { key:"teach_engage", label:"Have you seen engagement from students in your courses?", type:"yesno" },
    { key:"teach_reco", label:"Would you recommend teaching on Learn with Illume to other leather professionals?", type:"single",
      options:["Yes","No"] },
    { key:"teach_why_no", label:"If no, why?", type:"text", showIf:{ field:"teach_reco", equals:"No" } },
    { key:"teach_support", label:"What support or resources would help you create better courses?", type:"text" }
  ],
  "Event Attendee": [
    { key:"evt_sat", label:"How satisfied were you with the event?", type:"scale5" },
    { key:"evt_best", label:"What part of the event did you enjoy the most?", type:"single",
      options:["Vendor hall","Competitions","Classes","Networking","Post-show events","Event staff"], other:true },
    { key:"evt_class", label:"Did you attend a class?", type:"single", options:["No","Yes"] },
    { key:"evt_class_rate", label:"If yes, how would you rate it?", type:"scale5", showIf:{ field:"evt_class", equals:"Yes" } },
    { key:"evt_return", label:"How likely are you to attend again next year?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] }
  ],
  "Event Vendor": [
    { key:"ven_sat", label:"How satisfied were you with your vending experience?", type:"scale5" },
    { key:"ven_goal", label:"Did you meet your sales expectations?", type:"yesno" },
    { key:"ven_aud", label:"What type of attendees were most interested in your products?", type:"checkbox",
      options:["Hobbyists","Small business owners","Manufacturers"], other:true },
    { key:"ven_again", label:"How likely are you to return as a vendor next year?", type:"single",
      options:["Not likely","Likely","Highly likely","Definitely"] },
    { key:"ven_improve", label:"What would improve your experience as a vendor?", type:"text" }
  ],
  "Event Instructor": [
    { key:"einst_sat", label:"How satisfied were you with your teaching experience at the event?", type:"scale5" },
    { key:"einst_eng", label:"Did your class meet or exceed your expectations for engagement?", type:"yesno" },
    { key:"einst_next", label:"Would you be interested in teaching again next year?", type:"yesno" },
    { key:"einst_reco", label:"How likely are you to recommend teaching at our events to other leather industry professionals?", type:"scale5" }
  ]
};
    
// ---- One submission lock (14 days) ----
const SUBMIT_LOCK_KEY = "illume:submission_lock";
const SUBMIT_LOCK_MS  = 14 * 24 * 60 * 60 * 1000; // 14 days

function readLock() {
  try { return JSON.parse(localStorage.getItem(SUBMIT_LOCK_KEY) || "null"); }
  catch (_) { return null; }
}
function isLocked() {
  const info = readLock();
  return !!(info && typeof info.at === "number" && (Date.now() - info.at) < SUBMIT_LOCK_MS);
}
function lockUntilTs() {
  const info = readLock();
  return info ? (info.at + SUBMIT_LOCK_MS) : null;
}
function setLockNow() { localStorage.setItem(SUBMIT_LOCK_KEY, JSON.stringify({ at: Date.now() })); }
function clearLock()   { localStorage.removeItem(SUBMIT_LOCK_KEY); }

function setFormDisabled(disabled) {
  // limit to the survey form area so admin buttons still work
  document.querySelectorAll('.wrap .card input, .wrap .card select, .wrap .card textarea, .wrap .card button#submitBtn')
    .forEach(el => el.disabled = disabled);
}

function formatUntil(ts) { try { return new Date(ts).toLocaleString(); } catch { return ""; } }

function updateLockUI() {
  const notice = document.getElementById("lockNotice");
  if (isLocked()) {
    notice && (
      notice.textContent = `You already submitted. You can submit again on ${formatUntil(lockUntilTs())}.`,
      notice.classList.remove("hide")
    );
    setFormDisabled(true);
  } else {
    notice && notice.classList.add("hide");  // <- this line was cut off
    setFormDisabled(false);
  }
}

  document.addEventListener("DOMContentLoaded", updateLockUI);

// --- Role normalization helpers ---
const ROLE_MAP = Object.keys(schema).reduce((m,k)=>{ m[k.toLowerCase()] = k; return m; }, {});
const normalizeRole = (v) => ROLE_MAP[(v || "").trim().toLowerCase()] || "";

/* ============== State ============== */
const STORAGE_KEY = "illume_feedback_responses_v5";
const responses = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
const $ = (sel) => document.querySelector(sel);
const roleSel = $("#role");
const formFields = $("#formFields");

/* ============== UI Builders ============== */
function clearChildren(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function makeSelect(options, placeholder="Select..."){
  const s = document.createElement("select");
  const ph = document.createElement("option");
  ph.value = ""; ph.textContent = placeholder;
  s.appendChild(ph);
  options.forEach(opt => { const o = document.createElement("option"); o.textContent = opt; s.appendChild(o); });
  return s;
}
function makeScale5(){ return makeSelect(["1","2","3","4","5"], "1 to 5"); }
function makeYesNo(){ return makeSelect(["Yes","No"], "Yes or No"); }
function makeCheckboxPills(options, other){
  const wrap = document.createElement("div"); wrap.className = "choices";
  options.forEach(opt => {
    const pill = document.createElement("label"); pill.className = "pill";
    const input = document.createElement("input"); input.type = "checkbox"; input.value = opt;
    pill.appendChild(input); pill.appendChild(document.createTextNode(opt));
    wrap.appendChild(pill);
  });
  if(other){
    const pill = document.createElement("label"); pill.className = "pill";
    const input = document.createElement("input"); input.type = "checkbox"; input.value = "__OTHER__";
    const txt = document.createElement("input"); txt.type = "text"; txt.className = "inline-input"; txt.maxLength = 100; txt.placeholder = "Other (max 100 chars)";
    pill.appendChild(input); pill.appendChild(document.createTextNode("Other")); pill.appendChild(txt);
    wrap.appendChild(pill);
  }
  return wrap;
}
function getCheckboxValues(wrap){
  const vals = [];
  wrap.querySelectorAll("label").forEach(l => {
    const cb = l.querySelector('input[type="checkbox"]');
    if(cb && cb.checked){
      if(cb.value === "__OTHER__"){
        const t = l.querySelector('input[type="text"]');
        if(t && t.value.trim()) vals.push(t.value.trim());
      } else {
        vals.push(cb.value);
      }
    }
  });
  return vals;
}

function renderField(def){
  const holder = document.createElement("div");
  holder.dataset.key = def.key;
  holder.dataset.required = (def.required === false ? "false" : "true");
  const label = document.createElement("label"); label.innerHTML = def.label + ' <span class="req">*</span>';
  holder.appendChild(label);
  let control;
  if(def.type === "scale5") control = makeScale5();
  else if(def.type === "single") {
    control = makeSelect([...(def.options||[]), ...(def.other?["Other"]:[])]);
    if(def.other){
      const otherBox = document.createElement("input");
      otherBox.type="text"; otherBox.className="inline-input hide"; otherBox.maxLength=100; otherBox.placeholder="Other (max 100 chars)";
      control.addEventListener("change", ()=>{
        if(control.value === "Other") otherBox.classList.remove("hide");
        else { otherBox.value = ""; otherBox.classList.add("hide"); }
      });
      holder.appendChild(control);
      holder.appendChild(otherBox);
      control.dataset.otherInputId = Math.random().toString(36).slice(2);
      otherBox.dataset.bindTo = control.dataset.otherInputId;
      return holder;
    }
  }
  else if(def.type === "yesno") control = makeYesNo();
  else if(def.type === "text") { control = document.createElement("textarea"); control.placeholder = "Type your answer"; }
  else if(def.type === "checkbox") control = makeCheckboxPills(def.options || [], !!def.other);
  else control = document.createElement("input");
  if(control) control.dataset.type = def.type;
  holder.appendChild(control);
  if(def.showIf){ holder.dataset.showIf = JSON.stringify(def.showIf); holder.classList.add("hide"); }
  return holder;
}

function evaluateVisibility(){
  const map = {};
  formFields.querySelectorAll("[data-key]").forEach(block => {
    const key = block.dataset.key;
    const select = block.querySelector("select");
    const area = block.querySelector("textarea");
    const choices = block.querySelector(".choices");
    let value = "";
    if(select){ value = select.value; }
    else if(area){ value = area.value; }
    else if(choices){ value = getCheckboxValues(choices).join("; "); }
    map[key] = value;
  });
  formFields.querySelectorAll("[data-key]").forEach(block => {
    const rule = block.dataset.showIf ? JSON.parse(block.dataset.showIf) : null;
    if(!rule){ block.classList.remove("hide"); return; }
    const current = map[rule.field] || "";
    if(current === rule.equals) block.classList.remove("hide");
    else block.classList.add("hide");
  });
}

function renderForm(){
  clearChildren(formFields);
  const roleKey = normalizeRole(roleSel?.value);
  const defs = roleKey ? schema[roleKey] : null;
  if(!defs) return;  // nothing to render yet
  defs.forEach(def => formFields.appendChild(renderField(def)));
  // keep visibility reactive
  formFields.removeEventListener("input", evaluateVisibility);
  formFields.removeEventListener("change", evaluateVisibility);
  formFields.addEventListener("input", evaluateVisibility);
  formFields.addEventListener("change", evaluateVisibility);
  evaluateVisibility();
}

// attach after DOM is ready, and also render once in case a value is preselected
document.addEventListener("DOMContentLoaded", () => {
  roleSel?.addEventListener("change", renderForm);
  renderForm();
});

/* ============== Validate and Collect ============== */
function validateAndCollect(){
  const role = roleSel.value;
  if(!role){ alert("Please choose your customer type first."); return null; }

  const out = { _ts:new Date().toISOString(), role };
  out.first_name = (document.getElementById("firstName").value || "").trim();
  out.last_name  = (document.getElementById("lastName").value || "").trim();
  out.email      = (document.getElementById("email").value || "").trim();

  let ok = true, problems = [];
  formFields.querySelectorAll("[data-key]").forEach(block => {
    const hidden = block.classList.contains("hide");
    if(hidden) return;
    const key = block.dataset.key;
    const required = block.dataset.required !== "false";
    const select = block.querySelector("select");
    const area = block.querySelector("textarea");
    const choices = block.querySelector(".choices");

    let value = "";
    if(select){
      value = select.value.trim();
      if(select.dataset.otherInputId){
        const match = formFields.querySelector(`input.inline-input[data-bind-to="${select.dataset.otherInputId}"]`);
        if(select.value === "Other"){
          const v = match.value.trim();
          if(v.length === 0) { ok = false; problems.push(block); }
          value = v;
        }
      }
    } else if(area){ value = area.value.trim(); }
    else if(choices){
      const vals = getCheckboxValues(choices);
      value = vals.join("; ");
      if(required && vals.length === 0) { ok = false; problems.push(block); }
    }
    if(required && !choices && !value){ ok = false; problems.push(block); }
    out[key] = value;
  });

  if(!ok){
    problems[0]?.scrollIntoView({ behavior:"smooth", block:"center" });
    alert("Please complete all required fields.");
    return null;
  }
  return out;
}

/* ============== Export Helpers ============== */
function toCSV(rows){
  if(rows.length === 0) return "";
  const cols = Array.from(rows.reduce((set,row)=>{ Object.keys(row).forEach(k=>set.add(k)); return set; }, new Set()));
  const esc = v => {
    const s = String(v==null ? "" : v);
    if(/[\",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  const header = cols.map(esc).join(",");
  const body = rows.map(r => cols.map(c => esc(r[c]||"")).join(",")).join("\n");
  return header + "\n" + body;
}
function normalizedJSON(rows){
  const byRole = {};
  for(const r of rows){
    const role = r.role || "Unknown";
    if(!byRole[role]) byRole[role] = [];
    const sorted = Object.keys(r).sort().reduce((o,k)=>{ o[k]=r[k]; return o; }, {});
    byRole[role].push(sorted);
  }
  const totals = Object.fromEntries(Object.entries(byRole).map(([k,v])=>[k,v.length]));
  return { exported_at:new Date().toISOString(), total:rows.length, totals_by_role:totals, by_role:byRole };
}
function download(data, filename, type){
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ============== Modal ============== */
function openModal(summaryHtml){
  const bd = document.getElementById("backdrop");
  const body = document.getElementById("confirmBody");
  body.innerHTML = summaryHtml;
  bd.style.display = "flex";
}
function closeModal(){ document.getElementById("backdrop").style.display = "none"; }
document.getElementById("closeModal").addEventListener("click", closeModal);
document.getElementById("downloadCsvQuick").addEventListener("click", ()=>{
  const csv = toCSV(responses);
  if(!csv){ alert("No responses yet."); return; }
  download(csv, "illume_responses.csv", "text/csv");
});

/* ============== Google Sheets Hook ============== */
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxf1JGJVQpDMKkTEFpO4f8ecjuiMs2pKYRAiFrbzquZP2MGIa6yB3_q9iiIXaxnG88D/exec";
// Warm up Apps Script once the page loads
window.addEventListener("load", () => {
  fetch(SHEETS_ENDPOINT + "?v=" + Date.now(), { method: "GET", cache: "no-store" }).catch(()=>{});
});

async function postToSheets(row) {
  const url = SHEETS_ENDPOINT + "?v=" + Date.now();
  const ctrl = new AbortController();
  const to = setTimeout(() => ctrl.abort(), 12000);

  const opts = {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(row),
    cache: "no-store",
    signal: ctrl.signal
  };

  async function tryOnce() {
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return res.json();
  }

  try {
    const data = await tryOnce();
    clearTimeout(to);
    return typeof data === "object" ? data : { ok:false, error:"Non-JSON response" };
  } catch (e) {
    await new Promise(r => setTimeout(r, 600));
    try {
      const data = await tryOnce();
      clearTimeout(to);
      return data;
    } catch (e2) {
      clearTimeout(to);
      const msg = e2 && e2.name === "AbortError" ? "Request timed out" : String(e2 && e2.message || e2);
      return { ok:false, error: msg };
    }
  }
}

/* ============== Submit Handler ============== */
document.getElementById("submitBtn").addEventListener("click", async ()=>{
  // 1) block if locked
  if (isLocked()) { 
    updateLockUI();
    alert("Thanks! You already submitted. Try again after the cooldown.");
    return;
  }

  // 2) collect
  const row = validateAndCollect(); 
  if (!row) return;

  // 3) save locally
  responses.push(row);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(responses));

  // 4) send to Sheets
  const result = await postToSheets(row);

  // 5) NOW set the 14 day lock and refresh the UI
  setLockNow();
  updateLockUI();

  // 6) build summary and show modal
  const who = [row.first_name, row.last_name].filter(Boolean).join(" ");
  const statusLine = result.ok ? "Saved to Sheets" : "Saved locally only";
  const extra = result.ok
    ? `<br><strong>Sheets time:</strong> ${result.stored_at || ""}`
    : `<br><strong>Warning:</strong> ${result.error || "Offline or blocked"}`;

  const summary = `<p><strong>Submitted</strong> at ${new Date(row._ts).toLocaleString()}`
    + `<br><strong>Customer type:</strong> ${row.role}`
    + `${who ? "<br><strong>Name:</strong> " + who : ""}`
    + `${row.email ? "<br><strong>Email:</strong> " + row.email : ""}`
    + `<br><strong>Cooldown ends:</strong> ${formatUntil(lockUntilTs())}`
    + `<br><strong>Status:</strong> ${statusLine}${extra}</p>`;
  openModal(summary);

  // 7) clear inputs for good measure
  formFields.querySelectorAll("select").forEach(s=>s.value="");
  formFields.querySelectorAll("textarea").forEach(t=>t.value="");
  formFields.querySelectorAll(".choices input[type=checkbox]").forEach(c=>c.checked=false);
  formFields.querySelectorAll(".inline-input").forEach(t=>{ t.value=""; t.classList.add("hide"); });
});


/* ============== Admin buttons ============== */
document.getElementById("exportCsvBtn").addEventListener("click", ()=>{
  const csv = toCSV(responses);
  if(!csv){ alert("No responses yet."); return; }
  download(csv, "illume_responses.csv", "text/csv");
});
document.getElementById("exportJsonBtn").addEventListener("click", ()=>{
  const obj = normalizedJSON(responses);
  download(JSON.stringify(obj, null, 2), "illume_responses.json", "application/json");
});
document.getElementById("importJsonBtn").addEventListener("click", ()=>{
  const inp = document.createElement("input"); inp.type="file"; inp.accept="application/json";
  inp.onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try {
        const data = JSON.parse(reader.result);
        const rows = Array.isArray(data) ? data : (data.by_role ? Object.values(data.by_role).flat() : []);
        if(!rows || rows.length === 0) throw new Error("No rows found in JSON");
        responses.length = 0; rows.forEach(r=>responses.push(r));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(responses));
        alert("Imported");
      } catch(err){ alert("Import failed: " + err.message); }
    };
    reader.readAsText(file);
  };
  inp.click();
});
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if(confirm("Remove all locally stored responses?")) {
    localStorage.removeItem(STORAGE_KEY);
    alert("Cleared");
    location.reload();
  }
});
  </script>
</body>
</html>
